<lms-confirm-modal id="confirmModal" modalTitle="Confirmation" modalMessage="Are you sure you want to delete this user?"
                   (onOkClick)="onDeleteConfirmed()">
</lms-confirm-modal>
<lms-upload-modal [abilityToUpload]="isManage" [fieldObject]="selectedUser" fieldName="imageUrl"
                  (uploadImageClick)="updateUser($event)"
                  [prevFieldObject]="utils.getPrevObj()"></lms-upload-modal>

<div *ngIf="isManage" class="modal fade" data-backdrop="static" id="userModal" role="dialog">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">User Details</h4>
      </div>
      <ul class="cap-tabs nav nav-tabs">
        <li id="userDetails" class="nav-item active">
          <a class="nav-link">Details</a>
        </li>
        <li id="userRoles" class="nav-item">
          <a class="nav-link">Role</a>
        </li>
      </ul>
      <div class="modal-body">

        <div id="tab-content-userDetails">

          <lms-input label="Username"  fieldName="username"
                     [fieldObject]="selectedUser" fieldType="text" capPattern="^\w{5,50}$" [capRequired]="true"
                     alertText="Username must contain minimum 5 characters"></lms-input>


          <lms-input [visible]="!(selectedUser && selectedUser.id)" label="Password"
                     fieldName="password" [fieldObject]="selectedUser"
                     fieldType="password" capPattern="^\w{8,50}$" [capRequired]="true"
                     alertText="Password must contain minimum 8 characters"></lms-input>

          <lms-input [visible]="!(selectedUser && selectedUser.id)" label="Repeat Password" fieldName="passwordRepeated"
                     [fieldObject]="this"
                     fieldType="password"></lms-input>
          <small class="lms-alert"
                 [hidden]="!(selectedUser && selectedUser.id && (!selectedUser.password || !passwordRepeated || selectedUser.password != passwordRepeated) && (passwordRepeated && passwordRepeated.length > 1))">
            Passwords don't match
          </small>

          <lms-input label="First Name" fieldName="firstName" [fieldObject]="selectedUser"
                     fieldType="text" capPattern="^.{2,50}$" [capRequired]="true"
                     alertText="First Name must contain minimum 2 characters"></lms-input>

          <lms-input label="Last Name" fieldName="lastName" [fieldObject]="selectedUser"
                     fieldType="text" capPattern="^.{2,50}$" [capRequired]="true"
                     alertText="Last Name must contain minimum 2 characters"></lms-input>

          <lms-input label="Phone" fieldName="phone" [fieldObject]="selectedUser"
                     fieldType="text"></lms-input>


          <lms-input label="Email" fieldName="email" [fieldObject]="selectedUser"
                     capPattern="^(?=.{1,50}$)[a-z]+[a-z0-9._]+@[a-z]+\.[a-z.]{2,5}$" [capRequired]="true"
                     alertText="Not valid email"
                     fieldType="text"></lms-input>

          <lms-checkbox [visible]="(selectedUser && selectedUser.id)" label="Active" fieldName="active"
                        [fieldObject]="selectedUser"></lms-checkbox>
        </div>

        <div id="tab-content-userRoles" class="hide">
          <lms-multi-checkbox [items]="roles" viewName="name"
                              [targetObject]="selectedUser" targetObjectField="roles"
                              identifier="id"></lms-multi-checkbox>
        </div>

      </div>
      <div class="modal-footer">
        <button *ngIf="(selectedUser && selectedUser.id)" type="button" class="btn btn-danger left"
                (click)="deleteUser()">Delete
        </button>
        <button *ngIf="(selectedUser && selectedUser.id)" type="button" class="btn btn-success"
                (click)="updateUser()">Update
        </button>
        <button *ngIf="!(selectedUser && selectedUser.id)" type="button" class="btn btn-success"
                (click)="saveUser()"
                [disabled]="selectedUser && (!(selectedUser.password && passwordRepeated) || selectedUser.password != passwordRepeated) ">
          Save
        </button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="">
  <div class="page-title">
    <div class="title_left">
      <h3>Users
        <small>Managing user records</small>
      </h3>
    </div>
  </div>

  <div class="clearfix"></div>

  <lms-table [items]="users"
             (rowDoubleClick)="showAddEditModal($event)"
             (onAddButtonClick)="showAddModal($event)"
             [addable]="isManage"
             [editable]="isManage"
             [searchable]="true"
             [advanceFilter]="true"
             (onFilteredClick)="filterClicked($event)"
             (onTermSearch)="updateUsersData($event)"
             [pagination]="true"
             [pageNum]="pageNum"
             [reloadEvent]="loader"
             (onPageChange)="changePage($event)"

  >
    <lms-column header="" field="imageUrl">
      <ng-template #dataTableCell let-item="item">
        <div class="user-profile img-square cap-pointer cap-hover" title="Upload Image" (click)="openImageModal(item)">
          <img src="{{item.imageUrl}}" alt="NO IMAGE"></div>
      </ng-template>
    </lms-column>
    <lms-column header="ID" field="id"></lms-column>
    <lms-column header="User Name" field="username" filtered="text"></lms-column>
    <lms-column header="First Name" field="firstName" filtered="text"></lms-column>
    <lms-column header="Last Name" field="lastName" filtered="text"></lms-column>
    <lms-column header="Email" field="email" filtered="text"></lms-column>
    <lms-column header="Phone" field="phone" filtered="text"></lms-column>
    <lms-column header="Creation Date" field="creationDate" filtered="date">
      <ng-template #dataTableCell let-item="item">
        <span>{{item.creationDate | date:'dd/MM/yyyy HH:mm' }}</span>
      </ng-template>
    </lms-column>
    <lms-column header="Modification Date" field="modificationDate" filtered="date">
      <ng-template #dataTableCell let-item="item">
        <span>{{item.modificationDate | date:'dd/MM/yyyy HH:mm:ss' }}</span>
      </ng-template>
    </lms-column>
    <lms-column header="Roles" field="roles" type="list" filtered="combo" [filteredOptions]="roles"
                filteredFieldName="roleId" filteredOptionName="name" filteredOptionValue="id" [filteredOptionReturnObject]="false">
      <ng-template #dataTableCell let-item="item">
        <span class="lms-tag" *ngFor="let role of item.roles" [ngStyle]="{'background-color': role.color }">{{role.name}}</span>
      </ng-template>
    </lms-column>
    <lms-column header="Active" field="active" filtered="checkbox">
      <ng-template #dataTableCell let-item="item">
        <div *ngIf="item.active" class="text-center"><i class="fa fa-check-circle f-16 green"></i></div>
        <div *ngIf="!item.active" class="text-center"><i class="fa fa-times-circle f-16 red"></i></div>
      </ng-template>
    </lms-column>
  </lms-table>

</div>
